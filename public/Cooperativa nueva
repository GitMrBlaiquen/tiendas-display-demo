// ---------------------------
// Main
// ---------------------------
async function loadConfigAndBuild() {
  hideError();

  const token = getTokenFromPath();
  if (!token) {
    showError("Falta token", "Usa /tv/TOKEN\nEj: https://smartcountify.cl/tv/AB12x9KQ");
    return false;
  }

  const cfg = await fetchJson(`${CONFIG_URL}?token=${encodeURIComponent(token)}`);
  const label = cfg?.label || "SmartCountify";
  const logo = String(cfg?.logo || "").trim(); // ✅ nuevo

  if (tvClient) tvClient.textContent = `Cliente: ${label}`;

  // ✅ Logo dinámico
  if (typeof tvClientLogo !== "undefined" && tvClientLogo) {
    if (logo) {
      tvClientLogo.src = logo;
      tvClientLogo.style.display = "block";
    } else {
      tvClientLogo.removeAttribute("src");
      tvClientLogo.style.display = "none";
    }
  }

  const list = Array.isArray(cfg?.stores) ? cfg.stores : [];
  if (!list.length) {
    showError("Sin tiendas", "Este token no tiene tiendas asignadas.");
    return false;
  }

  // Limitamos a 12 para el layout fijo 4x3
  storesList = list.slice(0, SLOTS);

  // Render fijo una vez
  render12SlotsOnce();
  return true;
}

async function pollLive() {
  if (!storesList.length) return;

  // Fetch paralelo solo de tiendas reales
  const tasks = storesList.map(async (s, idx) => {
    try {
      const counters = await fetchJson(`${COUNTERS_URL}?storeId=${encodeURIComponent(s.id)}`);
      updateStoreSlot(idx, counters);
    } catch {
      // si falla una tienda, no botamos todo
    }
  });

  await Promise.allSettled(tasks);
}

async function start() {
  clockTick();
  setInterval(clockTick, 1000);

  try {
    const ok = await loadConfigAndBuild();
    if (!ok) return;

    await pollLive();
    setInterval(pollLive, POLL_MS);
  } catch (e) {
    showError("No se pudo cargar TV", e?.message || String(e));
  }
}

start();